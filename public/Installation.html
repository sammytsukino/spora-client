<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>SPORA LAB 3.8 - BRUTALIST</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=UnifrakturMaguntia&family=Inter:wght@400;700&display=swap"
        rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <style>
        body {
            margin: 0;
            background: #000;
            color: #fff;
            font-family: 'Arial', sans-serif;
            height: 100dvh;
            overflow: hidden;
            display: flex;
        }

        #ui {
            width: 20vw;
            min-width: 280px;
            height: 100%;
            background: #e6e6e6;
            border-right: 1px solid #333;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
            overflow-x: hidden;
            z-index: 10;
        }

        #canvas-container {
            flex-grow: 1;
            height: 100%;
            position: relative;
            background: #000;
            overflow: hidden;
            background-position: center top;
            transition: background 0.2s ease;
        }

        canvas {
            display: block;
        }

        textarea {
            width: 93%;
            height: 120px;
            background: #000;
            border: 1px solid #333;
            color: #eee;
            font-family: 'Arial', sans-serif;
            font-size: 13px;
            padding: 10px;
            resize: none;
            border-radius: 4px;
            outline: none;
        }

        textarea:focus {
            border-color: #8de22b;
        }

        .row {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .row-h {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #dcdcdc;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        h2 {
            margin: 0;
            font-size: 12px;
            color: #666;
            border-bottom: 1px solid #999;
            padding-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: bold;
        }

        label {
            font-size: 11px;
            color: #333;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: bold;
        }

        input[type=range] {
            width: 100%;
            cursor: pointer;
            accent-color: #8de22b;
        }

        input[type=checkbox] {
            transform: scale(1.2);
            cursor: pointer;
            accent-color: #8de22b;
        }

        input[type=color] {
            border: none;
            width: 30px;
            height: 30px;
            background: none;
            cursor: pointer;
            padding: 0;
        }

        input[type=text] {
            width: 100%;
            padding: 8px;
            border: 1px solid #999;
            border-radius: 4px;
            font-size: 11px;
            box-sizing: border-box;
        }

        select {
            width: 100%;
            padding: 8px;
            background: #fff;
            color: #000;
            border: 1px solid #999;
            border-radius: 4px;
            font-size: 11px;
            text-transform: uppercase;
            font-weight: bold;
        }

        button {
            width: 100%;
            padding: 15px;
            background: #8de22b;
            border: none;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            border-radius: 4px;
            margin-top: auto;
            color: #000;
            font-family: 'Arial', sans-serif;
        }

        button:hover {
            background: #88ff00;
        }

        .status {
            font-size: 10px;
            color: #555;
            text-align: center;
            margin-top: 10px;
        }

        details {
            background: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 8px 10px;
        }

        details+details {
            margin-top: 10px;
        }

        summary {
            cursor: pointer;
            list-style: none;
            font-size: 11px;
            color: #333;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: bold;
        }

        summary::-webkit-details-marker {
            display: none;
        }

        .folder-body {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }

        .debug-panel {
            margin-top: 20px;
            padding: 10px;
            background: #000;
            color: #fff;
            border-radius: 4px;
            border: 1px solid #8de22b;
        }
        .debug-panel h3 { font-size: 10px; margin: 0 0 5px 0; text-transform: uppercase; color: #8de22b; }
        .debug-btns { display: flex; gap: 5px; }
        .debug-btn { padding: 8px; font-size: 10px; font-weight: bold; background: #333; color: #fff; border: none; cursor: pointer; text-transform: uppercase; flex-grow: 1; }
        .debug-btn:hover { background: #8de22b; color: #000; }

        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            #ui {
                width: 100%;
                height: auto;
                max-height: 30dvh;
                border-right: none;
                border-bottom: 1px solid #333;
            }
        }
    </style>
</head>

<body>

    <div id="ui">
        <h2>Content</h2>
        <div class="row">
            <textarea id="txtInp"
                oninput="triggerRegen()">Self-hatred grows in me like cancer. I can't locate its whereabouts but it's feasting on its host. I expected him to have the answers. I thought I taught him how to love me Now he fears me like a ghost.</textarea>
        </div>

        <div class="debug-panel">
            <h3>Sentiment Simulator</h3>
            <div class="debug-btns">
                <button class="debug-btn" onclick="applyVisualState(moodProfiles.positive)">ACID JOY</button>
                <button class="debug-btn" onclick="applyVisualState(moodProfiles.negative)">VOID</button>
                <button class="debug-btn" onclick="applyVisualState(moodProfiles.chaos)">GLITCH</button>
            </div>
        </div>

        <h2>Geometry & Style</h2>
        <details open>
            <summary>Typography & Scale</summary>
            <div class="folder-body">
                <div class="row">
                    <label>Font Family</label>
                    <select id="selFont" onchange="triggerVisuals()">
                        <option value="Arial">System Sans (Arial)</option>
                        <option value="Inter">Modern (Inter)</option>
                        <option value="Playfair Display">Editorial (Playfair)</option>
                        <option value="Courier Prime">Code (Courier)</option>
                        <option value="UnifrakturMaguntia">Gothic (Unifraktur)</option>
                    </select>
                </div>
                <div class="row">
                    <label id="lblSize">Font Size: 16px</label>
                    <input type="range" id="rngSize" min="10" max="80" value="16"
                        oninput="updateUI('lblSize', 'Font Size', this.value, 'px'); triggerVisuals();">
                </div>
                <div class="row">
                    <label id="lblScale">Flower Scale: 1.5x</label>
                    <input type="range" id="rngScale" min="0.5" max="2.5" step="0.1" value="1.5"
                        oninput="updateUI('lblScale', 'Flower Scale', this.value, 'x'); triggerVisuals();">
                </div>
            </div>
        </details>

        <details>
            <summary>Fill & Colors</summary>
            <div class="folder-body">
                <div class="row">
                    <label>Fill Gradient Dir</label>
                    <select id="selFillDir" onchange="triggerVisuals()">
                        <option value="vertical">Vertical</option>
                        <option value="horizontal">Horizontal</option>
                        <option value="radial">Radial</option>
                    </select>
                </div>
                <div class="row-h">
                    <label for="chkMask">Show Fill</label>
                    <input type="checkbox" id="chkMask">
                </div>
                <div class="row-h">
                    <label for="chkFillGradient">Active Gradient</label>
                    <input type="checkbox" id="chkFillGradient">
                </div>
                <div class="row-h">
                    <label>Fill Solid / A</label>
                    <input type="color" id="colMaskGradA" value="#0000ff">
                </div>
                <div class="row-h">
                    <label>Fill B</label>
                    <input type="color" id="colMaskGradB" value="#00ffea">
                </div>
            </div>
        </details>

        <details>
            <summary>Outline</summary>
            <div class="folder-body">
                <div class="row-h">
                    <label for="chkOutline">Show Outline</label>
                    <input type="checkbox" id="chkOutline">
                </div>
                <div class="row">
                    <label id="lblOutlineWidth">Outline Width: 1px</label>
                    <input type="range" id="rngOutlineWidth" min="1" max="6" step="1" value="1"
                        oninput="updateUI('lblOutlineWidth', 'Width', this.value, 'px'); triggerVisuals();">
                </div>
                <div class="row-h">
                    <label>Outline Color</label>
                    <input type="color" id="colOutlineSolid" value="#ffffff">
                </div>
            </div>
        </details>

        <details open>
            <summary>Atmosphere & Chaos</summary>
            <div class="folder-body">
                <div class="row-h">
                    <label for="chkWind">Wind Active</label>
                    <input type="checkbox" id="chkWind">
                </div>
                <div class="row">
                    <label id="lblWind">Wind Strength: 0.5</label>
                    <input type="range" id="rngWind" min="0" max="2" step="0.1" value="0.5"
                        oninput="updateUI('lblWind', 'Wind Strength', this.value, '')">
                </div>
                
                <div class="row-h" style="border-left: 3px solid #8de22b; padding-left: 8px;">
                    <label for="chkScramble">Chaos: Scramble</label>
                    <input type="checkbox" id="chkScramble">
                </div>
                <div class="row-h" style="border-left: 3px solid #8de22b; padding-left: 8px;">
                    <label for="chkJitter">Chaos: Jitter</label>
                    <input type="checkbox" id="chkJitter">
                </div>

                <div class="row-h">
                    <label>Stem Color</label>
                    <input type="color" id="colStem" value="#15ff00">
                </div>
                <div class="row-h">
                    <label>Text Color</label>
                    <input type="color" id="colTextSolid" value="#ffffff">
                </div>
            </div>
        </details>

        <details>
            <summary>Background</summary>
            <div class="folder-body">
                <div class="row">
                    <label>BG Mode</label>
                    <select id="selBgMode" onchange="updateBackground()">
                        <option value="gradient">Gradient</option>
                        <option value="solid">Solid Color</option>
                        <option value="tile">Image Pattern (Tile)</option>
                        <option value="stretch">Image Stretch</option>
                    </select>
                </div>

                <div class="row">
                    <label>Image URL</label>
                    <input type="text" id="inpBgUrl" value="https://images.fineartamerica.com/images/artworkimages/mediumlarge/2/cosmos-flower-on-black-background-mike-hill.jpg"
                        onchange="updateBackground()">
                </div>

                <div class="row">
                    <label id="lblBgStretchY">Vertical Force: 100%</label>
                    <input type="range" id="rngBgStretchY" min="100" max="300" value="100"
                        oninput="updateUI('lblBgStretchY', 'Vertical Force', this.value, '%'); updateBackground()">
                </div>

                <div class="row-h">
                    <label>Gradient A / Solid</label>
                    <input type="color" id="colBgGradA" value="#0000ff" oninput="updateBackground()">
                </div>
                <div class="row-h">
                    <label>Gradient B</label>
                    <input type="color" id="colBgGradB" value="#ffffff" oninput="updateBackground()">
                </div>
                <div class="row">
                    <label id="lblBgAngle">Gradient Angle: 180deg</label>
                    <input type="range" id="rngBgAngle" min="0" max="360" value="180"
                        oninput="updateUI('lblBgAngle', 'Gradient Angle', this.value, 'deg'); updateBackground()">
                </div>
            </div>
        </details>

        <button onclick="generateGarden()">Regenerate Seed</button>
        <div class="status" id="statusText">System Ready</div>
    </div>

    <div id="canvas-container"></div>

    <script>
        let flowers = [];
        let targetFlowerSet = null; 

        const maskUrls = {
            daisy: [
                "https://res.cloudinary.com/dsy30p7gf/image/upload/v1770636190/img-4_oqbcpb.png",
                "https://res.cloudinary.com/dsy30p7gf/image/upload/v1770636194/img-3_pm6vm5.png",
                "https://res.cloudinary.com/dsy30p7gf/image/upload/v1770636194/img-2_tosyul.png",
                "https://res.cloudinary.com/dsy30p7gf/image/upload/v1770636193/img-1_wopfs4.png",
                "https://res.cloudinary.com/dsy30p7gf/image/upload/v1770637077/filled-1_2_vsngfl.png",
                "https://res.cloudinary.com/dsy30p7gf/image/upload/v1770637078/filled-0_2_w9rh7y.png",
            ],
            carnation: [
                "https://res.cloudinary.com/dsy30p7gf/image/upload/v1770636207/img-8_xeah1b.png",
                "https://res.cloudinary.com/dsy30p7gf/image/upload/v1770636207/img-7_hzirh9.png",
                "https://res.cloudinary.com/dsy30p7gf/image/upload/v1770636204/img-5_koy5ks.png",
                "https://res.cloudinary.com/dsy30p7gf/image/upload/v1770636832/filled-4_sn6mnd.png",
                "https://res.cloudinary.com/dsy30p7gf/image/upload/v1770636834/filled-3_ukp1hd.png",
                "https://res.cloudinary.com/dsy30p7gf/image/upload/v1770636856/filled-2_aurbfg.png",
            ],
            orchid: [
                "https://res.cloudinary.com/dsy30p7gf/image/upload/v1770636219/img-12_spjimp.png",
                "https://res.cloudinary.com/dsy30p7gf/image/upload/v1770636227/img-16_wvlvci.png",
                "https://res.cloudinary.com/dsy30p7gf/image/upload/v1770636220/img-13_oofcme.png",
                "https://res.cloudinary.com/dsy30p7gf/image/upload/v1770636849/filled-0_t10fbi.png",
                "https://res.cloudinary.com/dsy30p7gf/image/upload/v1770636848/filled-10_guyxib.png",
                "https://res.cloudinary.com/dsy30p7gf/image/upload/v1770636839/filled-9_qpc2dd.png",
            ],
            rose: [
                "https://res.cloudinary.com/dsy30p7gf/image/upload/v1770636237/img-19_dksffa.png",
                "https://res.cloudinary.com/dsy30p7gf/image/upload/v1770636245/img-23_vel44w.png",
                "https://res.cloudinary.com/dsy30p7gf/image/upload/v1770636238/img-18_xjxkrf.png",
                "https://res.cloudinary.com/dsy30p7gf/image/upload/v1770636236/img-17_mtu34q.png",
                "https://res.cloudinary.com/dsy30p7gf/image/upload/v1770636853/filled-1_a0npdc.png",
                "https://res.cloudinary.com/dsy30p7gf/image/upload/v1770636836/filled-7_qcnn41.png",
                "https://res.cloudinary.com/dsy30p7gf/image/upload/v1770636838/filled-8_fnbj0j.png",
            ],
        };


        let loadedAssets = {};
        let debounceTimer;
        let visualDebounce;
        const BASE_SIZE = 280;

        function preload() {
            Object.keys(maskUrls).forEach(setName => {
                loadedAssets[setName] = maskUrls[setName].map(url => loadImage(url));
            });
        }

        function setup() {
            const container = document.getElementById('canvas-container');
            const cnv = createCanvas(1, 1);
            cnv.parent('canvas-container');

            pixelDensity(1);
            frameRate(30);
            updateBackground();

            setTimeout(() => windowResized(), 0);
        }

        function forceAlpha(c) {
            c.setAlpha(255);
            return c;
        }

        function draw() {
            clear();

            const windOn = document.getElementById('chkWind').checked;
            const windForce = parseFloat(document.getElementById('rngWind').value);

            const scrambleOn = document.getElementById('chkScramble').checked;
            const jitterOn = document.getElementById('chkJitter').checked;

            const maskOn = document.getElementById('chkMask').checked;
            const outlineOn = document.getElementById('chkOutline').checked;
            const fillGradientOn = document.getElementById('chkFillGradient').checked;
            const selFont = document.getElementById('selFont').value;
            const fillDir = document.getElementById('selFillDir').value;

            textFont(selFont);

            const fillSolidColor = forceAlpha(color(document.getElementById('colMaskGradA').value));
            const fillGradA = forceAlpha(color(document.getElementById('colMaskGradA').value));
            const fillGradB = forceAlpha(color(document.getElementById('colMaskGradB').value));
            const outlineColor = forceAlpha(color(document.getElementById('colOutlineSolid').value));
            const textColor = forceAlpha(color(document.getElementById('colTextSolid').value));
            const cStem = color(document.getElementById('colStem').value);

            const time = millis() * 0.001;

            flowers.forEach((f, i) => {
                let swayX = 0, swayRot = 0, bend = f.bend;

                if (windOn) {
                    const noise = sin(time + i + f.x * 0.01) + sin(time * 2 + i);
                    bend += noise * 35 * windForce;
                    swayRot = noise * 0.05 * windForce;
                    swayX = noise * 35 * windForce;
                }

                let depthBrightness = map(f.ty, height * 0.1, height * 0.8, 0.3, 1.0);
                depthBrightness = constrain(depthBrightness, 0.3, 1.0);
                stroke(red(cStem) * depthBrightness, green(cStem) * depthBrightness, blue(cStem) * depthBrightness, 255);
                strokeWeight(lerp(5, 15, f.h / height));
                noFill();

                const p0x = f.x, p0y = height + 10;
                const p2x = f.tx + swayX, p2y = f.ty;
                const p1x = p0x + bend * 0.5, p1y = p2y + (p0y - p2y) * 0.4;

                beginShape();
                for (let t = 0; t <= 1; t += 0.05) {
                    const mt = 1 - t;
                    vertex((mt * mt * p0x) + (2 * mt * t * p1x) + (t * t * p2x), (mt * mt * p0y) + (2 * mt * t * p1y) + (t * t * p2y));
                }
                endShape();

                push();
                translate(p2x, p2y);
                rotate(swayRot);

                let fillT = 0;
                if (fillGradientOn) {
                    if (fillDir === 'vertical') {
                        fillT = constrain(map(f.ty, 0, height, 0, 1), 0, 1);
                    } else if (fillDir === 'horizontal') {
                        fillT = constrain(map(f.tx, 0, width, 0, 1), 0, 1);
                    } else if (fillDir === 'radial') {
                        let d = dist(f.tx, f.ty, width / 2, height / 2);
                        let maxD = dist(0, 0, width / 2, height / 2);
                        fillT = constrain(map(d, 0, maxD, 0, 1), 0, 1);
                    }
                }

                if (maskOn && f.graphic) {
                    const finalFill = fillGradientOn ? forceAlpha(lerpColor(fillGradA, fillGradB, fillT)) : fillSolidColor;
                    tint(finalFill);
                    imageMode(CENTER);
                    noStroke();
                    image(f.graphic, 0, 0);
                    noTint();
                }

                if (outlineOn && f.graphicOutline) {
                    tint(outlineColor);
                    imageMode(CENTER);
                    noStroke();
                    image(f.graphicOutline, 0, 0);
                    noTint();
                }

                noStroke();
                textSize(f.fontSize);
                textAlign(CENTER, CENTER);
                fill(textColor);

                f.points.forEach((p, idx) => {
                    let charIndex = idx % f.chars.length;
                    let dispX = p.x;
                    let dispY = p.y;

                    if (windOn && windForce > 0) {
                        if (scrambleOn && random(3) < windForce * 0.02) {
                            charIndex = floor(random(f.chars.length));
                        }

                        if (jitterOn) {
                            let dynamicChunk = map(f.fontSize, 10, 80, 10, 3);
                            dynamicChunk = floor(constrain(dynamicChunk, 1, 10));

                            const chunkId = floor(idx / dynamicChunk);

                            const snapSpeed = 8.0;
                            const timeStep = floor(time * snapSpeed);

                            let sizeFactor = map(f.fontSize, 10, 80, 0.5, 2.5);
                            sizeFactor = constrain(sizeFactor, 0.5, 3.0);

                            const baseAmp = windForce * 5.0;
                            const amp = baseAmp * sizeFactor;

                            const noiseX = noise(chunkId * 0.1, timeStep * 0.5);
                            const noiseY = noise(chunkId * 0.1 + 500, timeStep * 0.5);

                            const shiftX = map(noiseX, 0, 1, -amp, amp);
                            const shiftY = map(noiseY, 0, 1, -amp, amp);

                            dispX += shiftX;
                            dispY += shiftY;
                        }
                    }

                    text(f.chars[charIndex], dispX, dispY);
                });
                pop();
            });
        }

        function generateGarden() {
            flowers.forEach(f => {
                f.graphic.remove();
                if (f.graphicOutline) f.graphicOutline.remove();
            });
            flowers = [];

            const text = document.getElementById('txtInp').value.trim();
            if (!text) return;

            const baseSize = parseInt(document.getElementById('rngSize').value);
            const sliderScale = parseFloat(document.getElementById('rngScale').value);
            const outlineWidth = parseInt(document.getElementById('rngOutlineWidth').value);

            const setNames = Object.keys(loadedAssets);
            const activeSetName = (targetFlowerSet && loadedAssets[targetFlowerSet]) 
                                  ? targetFlowerSet 
                                  : setNames[Math.floor(Math.random() * setNames.length)];
            
            const activeImages = loadedAssets[activeSetName];

            document.getElementById('statusText').innerText = `Set: ${activeSetName.toUpperCase()} | Calculating...`;

            const words = text.split(/\s+/);
            const count = constrain(ceil(words.length / 12), 2, 20);
            let densityFactor = (count > 5) ? map(count, 5, 20, 1.0, 0.55) : 1.0;
            const effectiveBaseScale = sliderScale * densityFactor;

            let chunks = [];
            if (words.length < count) {
                for (let i = 0; i < count; i++) chunks.push(text.split(''));
            } else {
                const wordsPerFlower = ceil(words.length / count);
                for (let i = 0; i < count; i++) {
                    let start = i * wordsPerFlower;
                    let segment = words.slice(start, start + wordsPerFlower);
                    if (segment.length > 0) chunks.push(segment.join(' ').split(''));
                }
                while (chunks.length < count) chunks.push(text.split(''));
            }

            const maxW = min(width, 1400);
            for (let i = 0; i < count; i++) {
                let best = null, attempts = 0;
                while (!best && attempts++ < 100) {
                    const scale = effectiveBaseScale * random(0.9, 1.1);
                    const radius = (BASE_SIZE * scale) / 2 + 5;
                    const spread = maxW * map(effectiveBaseScale, 0.5, 2.5, 0.35, 0.5);
                    const tx = width / 2 + random(-spread, spread);
                    const ty = height - (height * random(0.35, 0.85));

                    if (flowers.some(f => dist(tx, ty, f.tx, f.ty) < radius + f.radius)) continue;

                    const img = random(activeImages);
                    const fontSize = baseSize * random(0.9, 1.1);

                    const data = processImage(img, fontSize, scale, outlineWidth);

                    best = {
                        x: width / 2, tx, ty, h: height - ty,
                        bend: random(-100, 100),
                        chars: chunks[i],
                        points: data.points,
                        graphic: data.pg,
                        graphicOutline: data.pgOutline,
                        source: img,
                        fontSize,
                        radius,
                        relScale: scale / sliderScale,
                        relFont: fontSize / baseSize
                    };
                }
                if (best) flowers.push(best);
            }
            flowers.sort((a, b) => a.ty - b.ty);
            document.getElementById('statusText').innerText = `Ready. Flowers: ${flowers.length}`;
        }

        function updateVisuals() {
            const baseSize = parseInt(document.getElementById('rngSize').value);
            const sliderScale = parseFloat(document.getElementById('rngScale').value);
            const outlineWidth = parseInt(document.getElementById('rngOutlineWidth').value);

            const count = flowers.length;
            let densityFactor = (count > 5) ? map(count, 5, 20, 1.0, 0.55) : 1.0;
            const effectiveBaseScale = sliderScale * densityFactor;

            flowers.forEach(f => {
                const newScale = effectiveBaseScale * f.relScale;
                const newSize = baseSize * f.relFont;
                f.graphic.remove();
                if (f.graphicOutline) f.graphicOutline.remove();

                const data = processImage(f.source, newSize, newScale, outlineWidth);

                f.points = data.points;
                f.graphic = data.pg;
                f.graphicOutline = data.pgOutline;
                f.fontSize = newSize;
                f.radius = (BASE_SIZE * newScale) / 2 + 5;
            });
        }

        function processImage(img, fSize, scale, outlineW) {
            const dim = Math.ceil(BASE_SIZE * scale);
            const pg = createGraphics(dim, dim);
            const pgOutline = createGraphics(dim, dim);
            pg.clear(); pgOutline.clear();

            const asp = img.width / img.height;
            const w = asp >= 1 ? dim : dim * asp;
            const h = asp >= 1 ? dim / asp : dim;
            const dx = (dim - w) / 2;
            const dy = (dim - h) / 2;

            pg.image(img, dx, dy, w, h);
            pg.loadPixels();

            const points = [];

            let spacingFactor = map(fSize, 10, 80, 1.0, 0.6);
            spacingFactor = constrain(spacingFactor, 0.6, 1.0);
            const step = Math.max(fSize * spacingFactor, 2);

            for (let y = 0; y < dim; y += step) {
                for (let x = 0; x < dim; x += step) {
                    const idx = (floor(x) + floor(y) * dim) * 4;
                    if (idx < pg.pixels.length && pg.pixels[idx + 3] > 20) {
                        points.push({ x: x - dim / 2, y: y - dim / 2 });
                    }
                }
            }

            const pW = pg.width;
            const edgePoints = [];
            for (let y = 1; y < dim - 1; y++) {
                for (let x = 1; x < dim - 1; x++) {
                    const i = (x + y * pW) * 4;
                    if (pg.pixels[i + 3] > 0) {
                        if (pg.pixels[i + 3 - 4] === 0 || pg.pixels[i + 3 + 4] === 0 ||
                            pg.pixels[i + 3 - pW * 4] === 0 || pg.pixels[i + 3 + pW * 4] === 0) {
                            edgePoints.push({ x, y });
                        }
                    }
                }
            }
            if (edgePoints.length > 0) {
                pgOutline.stroke(255);
                pgOutline.strokeWeight(outlineW);
                pgOutline.noFill();
                for (let pt of edgePoints) pgOutline.point(pt.x, pt.y);
            }

            for (let i = 0; i < pg.pixels.length; i += 4) {
                if (pg.pixels[i + 3] > 20) {
                    pg.pixels[i] = 255; pg.pixels[i + 1] = 255; pg.pixels[i + 2] = 255; pg.pixels[i + 3] = 255;
                } else {
                    pg.pixels[i + 3] = 0;
                }
            }
            pg.updatePixels();

            return { points, pg, pgOutline };
        }

        function updateBackground() {
            const mode = document.getElementById('selBgMode').value;
            const colA = document.getElementById('colBgGradA').value;
            const colB = document.getElementById('colBgGradB').value;
            const angle = document.getElementById('rngBgAngle').value;
            const url = document.getElementById('inpBgUrl').value;
            const container = document.getElementById('canvas-container');

            const stretchY = document.getElementById('rngBgStretchY').value;

            container.style.background = 'none';
            container.style.backgroundImage = 'none';
            container.style.backgroundSize = 'auto';
            container.style.backgroundRepeat = 'repeat';

            if (mode === 'solid') {
                container.style.backgroundColor = colA;
            } else if (mode === 'gradient') {
                container.style.background = `linear-gradient(${angle}deg, ${colA}, ${colB})`;
            } else if (mode === 'tile') {
                container.style.backgroundImage = `url('${url}')`;
                container.style.backgroundRepeat = 'repeat';
                container.style.backgroundSize = '100px 100px';
            } else if (mode === 'stretch') {
                container.style.backgroundImage = `url('${url}')`;
                container.style.backgroundRepeat = 'no-repeat';
                container.style.backgroundSize = `100% ${stretchY}%`;
            }
        }

        function triggerRegen() { clearTimeout(debounceTimer); debounceTimer = setTimeout(generateGarden, 400); }
        function triggerVisuals() { clearTimeout(visualDebounce); visualDebounce = setTimeout(updateVisuals, 100); }
        function updateUI(id, txt, val, unit) { document.getElementById(id).innerText = `${txt}: ${val}${unit}`; }
        function windowResized() {
            const c = document.getElementById('canvas-container');
            resizeCanvas(c.clientWidth, c.clientHeight);
            generateGarden();
        }
        window.addEventListener("orientationchange", () => setTimeout(windowResized, 300));

        const moodProfiles = {
            positive: {
                flowerSet: 'daisy',
                wind: { active: true, strength: 0.2 },
                chaos: { scramble: false, jitter: false },
                colors: { maskA: '#CCFF00', maskB: '#FFFFFF', stem: '#00FF00', text: '#000000', bgA: '#0000FF', bgB: '#CCFF00' },
                style: {
                    fill: { active: true, gradient: false, dir: 'radial' },
                    outline: { active: true, width: 2 }
                },
                geometry: { scale: 1.1, fontSize: 18, font: 'Inter' }
            },
            negative: {
                flowerSet: 'rose',
                wind: { active: true, strength: 0.1 },
                chaos: { scramble: false, jitter: false },
                colors: { maskA: '#000000', maskB: '#FF0000', stem: '#00FF00', text: '#FFFFFF', bgA: '#FF0000', bgB: '#000000' },
                style: {
                    fill: { active: true, gradient: true, dir: 'vertical' },
                    outline: { active: true, width: 1 }
                },
                geometry: { scale: 0.8, fontSize: 12, font: 'UnifrakturMaguntia' }
            },
            chaos: {
                flowerSet: 'carnation',
                wind: { active: true, strength: 2.0 },
                chaos: { scramble: true, jitter: true },
                colors: { maskA: '#FF00FF', maskB: '#00FF00', stem: '#00FF00', text: '#FFFF00', bgA: '#1a1a1a', bgB: '#330033' },
                style: {
                    fill: { active: false, gradient: false, dir: 'horizontal' },
                    outline: { active: true, width: 4 }
                },
                geometry: { scale: 2, fontSize: 55, font: 'Courier Prime' }
            }
        };

        function applyVisualState(state) {
            targetFlowerSet = state.flowerSet;

            document.getElementById('chkWind').checked = state.wind.active;
            document.getElementById('rngWind').value = state.wind.strength;
            updateUI('lblWind', 'Wind Strength', state.wind.strength, '');

            document.getElementById('chkScramble').checked = state.chaos.scramble;
            document.getElementById('chkJitter').checked = state.chaos.jitter;

            document.getElementById('colMaskGradA').value = state.colors.maskA;
            document.getElementById('colMaskGradB').value = state.colors.maskB;
            document.getElementById('colStem').value = state.colors.stem;
            document.getElementById('colTextSolid').value = state.colors.text;
            document.getElementById('colBgGradA').value = state.colors.bgA;
            document.getElementById('colBgGradB').value = state.colors.bgB;

            document.getElementById('chkMask').checked = state.style.fill.active;
            document.getElementById('chkFillGradient').checked = state.style.fill.gradient;
            document.getElementById('selFillDir').value = state.style.fill.dir;
            
            document.getElementById('chkOutline').checked = state.style.outline.active;
            document.getElementById('rngOutlineWidth').value = state.style.outline.width;
            updateUI('lblOutlineWidth', 'Width', state.style.outline.width, 'px');

            document.getElementById('rngScale').value = state.geometry.scale;
            updateUI('lblScale', 'Flower Scale', state.geometry.scale, 'x');
            
            document.getElementById('rngSize').value = state.geometry.fontSize;
            updateUI('lblSize', 'Font Size', state.geometry.fontSize, 'px');

            document.getElementById('selFont').value = state.geometry.font;

            updateBackground();
            generateGarden(); 
        }
    </script>
</body>

</html>